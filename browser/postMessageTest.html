<html>
<head>
    <script type="text/javascript" src="/node_modules/jquery/dist/jquery.min.js"></script>
    <script src="assets/js/three.js"></script>
    <script src="assets/js/OBJLoader.js"></script>
</head>

<body style="width:800px;margin: 0 auto">
<h1>postMessage</h1>

<script src="http://vizor.io/scripts/embed.js" data-vizorurl="http://vizor.io/vo/postmessage-obj?autoplay=1" ></script>

VR Mode:<input id="toggle" type="checkbox" />

Positions: 1 <input id="pos1" name="pos" type="radio" value="0"/>
2<input id="pos2" name="pos" type="radio" value="1"/>
3 <input id="pos3" name="pos" type="radio" value="2"/>
4 <input id="pos4" name="pos" type="radio" value="3"/><br/>
<input type="button" id="geo"</input>
<br>
    <pre id="log">
    </pre>

<script>
    var $log = $('#log');
    var $toggle = $('#toggle');
    var $position1 = $('#pos1');
    var $position2 = $('#pos2');
    var $position3 = $('#pos3');
    var $position4 = $('#pos4');
    var $geometry = $('#geo');

    // the embed script will create an iframe but right now one isn't available
    // so we defer setting this until send()
    var $vizor = null;

    function log(message) {
//        debugger;
        $log.append(message + '<br>')
    }
    function send(message) {
        if (!$vizor) {
            $vizor = $('iframe').first()
        }
        console.log(message.data);
        log('OUT: '+ JSON.stringify(message));
        $vizor[0].contentWindow.postMessage(message, '*')
    }
    $toggle.on('click', function(e) {
        console.log(e.currentTarget.checked);

        send({
            command: 'setVariable',
            name: 'cam_state',
            value: e.currentTarget.checked
        })
        send({
            command: 'getVariable',
            name: 'cam_state'
        })
    })
    $position1.on('click', function(e) {
        send({
            command: 'setVariable',
            name: 'cam_index',
            value: e.currentTarget.value
        })
        send({
            command: 'getVariable',
            name: 'cam_index'
        })
    })
    $position2.on('click', function(e) {
        send({
            command: 'setVariable',
            name: 'cam_index',
            value: e.currentTarget.value
        })
        send({
            command: 'getVariable',
            name: 'cam_index'
        })
    })
    $position3.on('click', function(e) {
        send({
            command: 'setVariable',
            name: 'cam_index',
            value: e.currentTarget.value
        })
        send({
            command: 'getVariable',
            name: 'cam_index'
        })
    })
    $position4.on('click', function(e) {
        send({
            command: 'setVariable',
            name: 'cam_index',
            value: e.currentTarget.value
        })
        send({
            command: 'getVariable',
            name: 'cam_index'
        })
    })
    $geometry.on('click', function (e){
        console.log($geometry.val());
        send({
            command: 'setVariable',
            name: 'obj_load',
            value: $geometry.val()
        })
        send({
            command: 'getVariable',
            name: 'obj_load'
        })
    });
    window.addEventListener('message', function(e) {
        log('IN: ' + JSON.stringify(e.data))
    }, false)
</script>

<script>
    var boxTexture = new THREE.ImageUtils.loadTexture("assets/business-card-box01.jpg",{},
            /* Success*/
            function () {
                console.log("Texture Loaded");
            },
            /* FAILURE */
            function (e) {
                console.error(e);
            });

    var boxMaterial = new THREE.MeshPhongMaterial({
        map: boxTexture,
        shininess: 40
    });

    var modelloader = new THREE.OBJLoader();
    modelloader.load('../assets/business-card-box.obj', completionCallback );

    var oldCompletionCallback = function (impObject) {
        impObject.children.forEach(function (child) {
            if (child instanceof THREE.Mesh) {
                child = new THREE.Mesh(new THREE.Geometry().fromBufferGeometry(child.geometry), boxMaterial);
                //decalMesh.name = "impObject";
                //scene.add(decalMesh);

                //decalTargets.push(decalMesh);
            }
        });

        completionCallback(impObject);
    };

    var completionCallback = function (objects) {
        console.log(objects.length);
    };
</script>
</body>
</html>